name: Calculate Build Version

on:
  workflow_call:
    outputs:
      version:
        description: "New build version number"
        value: ${{ jobs.calculate_version.outputs.output1 }}

jobs:
  calculate_version:
    name: Calculate Build Version
    runs-on: ubuntu-latest
    outputs:
      output1: ${{steps.versionStep.outputs.version}}
    steps:
    - name: Check out code
      uses: actions/checkout@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x
    - name: Download version file artifact
      uses: actions/download-artifact@v3
      continue-on-error: true
      with:
        name: buildVersion
        path: artifacts/versioning/buildVersion.txt
    - name: Increment build version
      id: versionStep
      shell: bash
      run: |
        [ -f buildVersion.txt ] && valu=`cat buildVersion.txt` || value="2.0.0-build1"
        buildVersionNumber=$((${value##*build} + 1))
        newVersionNumber="${value%%build*}build${buildVersionNumber}"
        expr $newVersionNumber > buildVersion.txt
        echo "::set-output name=version::${newVersionNumber}"
    - name: Upload version file aftifact
      uses: actions/upload-artifact@v3
      with:
        name: buildVersion
        path: artifacts/versioning/buildVersion.txt
